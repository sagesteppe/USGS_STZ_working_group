---
title: "Select Seed Lots under Climate Change Scenarios"
author: "Reed Benkendorf, Rob Massatti & Daniel Shyrock"
output: html_document
---


```{r}
library(sf)
library(tidyverse)
library(smoothr)
library(patchwork)
library(grid)
source('functions.R')
```

```{r read in polygons}
sz_current <- st_read('../data/CurrentZones.gpkg', quiet = T) |>
  sf::st_transform(5070) |>
  rename(Poly = ID)
sz_forecast <- st_read('../data/ClimateShiftedZones.gpkg', quiet = T) |>
  mutate(Poly = c('Western', 'East', 'Northern', 'Central'))|> # silly with the gui
  sf::st_transform(5070) # just set names here. 
```


```{r prepare data sets }

map_bb <- st_bbox( bind_rows(sz_current, sz_forecast))

sz_current <- prep_dat(sz_current)
sz_forecast <- prep_dat(sz_forecast)

ggplot() + 
  geom_sf(data = sz_current$enm, aes(fill = Poly)) + 
  geom_sf(data = sz_forecast$enm, aes(fill = Poly))
```

```{r Create filter}

filt <- st_polygon( 
    list(
      rbind(
        c(43, 1), c(57, 15), # bottom portion right
        c(57, 60), # stem portion right
        c(85, 100), c(15, 100), # very top of filter
        c(43, 60), # stem portion left
        c(43, 1)  # bottom portion left
      )
    )
  )  %>% 
  st_geometry()  %>% 
  st_as_sf(crs = 26913) %>% 
  mutate(Attribute = 'Filter') %>% 
  rename('geometry' = x) %>% 
  st_as_sf()

filt <- ggplot() + 
  geom_sf(data = filt) + 
  theme_minimal() +
  scale_y_continuous(breaks=c(0), labels = '        ') +
  scale_x_continuous(breaks = NULL) + 
  theme(
    aspect.ratio = 1, 
    panel.grid.major = element_blank(),
    axis.text.x = element_blank())

```

```{r Create plots}

sz_c <- ggplot(sz_current$SZ, aes(fill = Poly)) +
  geom_sf() + 
  coord_sf(xlim = map_bb[c(1,3)], ylim = map_bb[c(2,4)]) + 
  scale_x_continuous(breaks=c(-106, -109, -112)) + 
  theme_minimal() 

sz_f <- ggplot(sz_forecast$SZ, aes(fill = Poly)) +
  geom_sf() + 
  coord_sf(xlim = map_bb[c(1,3)], ylim = map_bb[c(2,4)]) + 
  scale_x_continuous(breaks=c(-106, -109, -112)) + 
  theme_minimal() 

enm_c <- ggplot(sz_current$enm, aes(fill = Poly)) +
  geom_sf() + 
  coord_sf(xlim = map_bb[c(1,3)], ylim = map_bb[c(2,4)]) + 
  scale_x_continuous(breaks=c(-106, -109, -112)) + 
  theme_minimal() 

enm_f <- ggplot(sz_forecast$enm, aes(fill = Poly)) +
  geom_sf() + 
  coord_sf(xlim = map_bb[c(1,3)], ylim = map_bb[c(2,4)]) + 
  scale_x_continuous(breaks=c(-106, -109, -112)) + 
  theme_minimal() 


rl_sz <- wrap_elements(panel = textGrob('Seed Zones', rot=90))
rl_enm <- wrap_elements(panel = textGrob('Ecological\nNiche Model', rot=90))
rl_filt <- wrap_elements(panel = textGrob('Filter', rot=90))

(rl_sz | sz_c | sz_f) / 
  (rl_enm | enm_c| enm_f) +
    (rl_filt | filt | filt) + 
          plot_layout(widths = c(0.1,1,1), guides='collect')


```


## Ecological Niche Model

An explosion in interest in mapping the ecological niche of species has resulted in a rich array of statistical approaches... 
An ENM can be fit to current species distribution records (from sources such as BISON, or GBIF), and predicted onto gridded surfaces under both current and future climate scenarios (see **Ensemble Climate Models**).  
Thresholding the probability surfaces allows for creating a binary mask which allows for restricting seed zones to areas which may support the species, and create more accurate estimates of realized seed zone sizes under current and future climate regimes.   

## Filter ('Sieve') Areas

Environmental filters can be effectively set by masking raster pixels into 0/1 conditions, whereby '0' or masked cells are removed from downstream analysis, and 1 pixels allow the inclusion of the pixel in downstream analyses. 

*National Land Cover Dataset (NLCD)* An annually updated data set, in the conterminous US, which details broad land cover classes.
NLCD can effectively be used to remove areas which have been converted to annual grass. 

*Protected Areas of the US Database (PADUS)* is updated every few years, and can be used to restrict ranges of analysis to public lands, by administrative agency (e.g. State, Federal, NGO) or agency (e.g. BLM, Forest Service) and combinations thereof. 

*Historic Seeding* Can be used to restrict seed collections from historically seeded areas. 

## Ensemble Climate Models

A variety of raster data sets exist which forecast future climate conditions under various CO~2~ relative concentration pathways (RCP). 
Most of these also include current and historic climate conditions, and hence can be used for modelling genecological zones under at various time points. 
While these data sets may not be as accurate as locally downscaled models (e.g. ClimateNA), they none the less provide results which may be useful for decision making. 

Either a single one of these data sets can be used, which are generally based on an ensembling approach, or the seed zone model can be fit to various climate predictions and subsequently ensembled. 

EXAMPLES: WorldClim, CHELSA, Noce et al. 2020 (a new global data set of bioclimatic indicators), 

## Restricting analysis using MESS or Area of Applicability surfaces

Complications with interpreting ecological niche models (ENMs) in climate shifted space, where novel combinations of climate variables may generate feature spaces training data were not sampled from, have fostered approaches for detecting spatial extrapolation in geostatistical models developed from sparse data sets as is common in ecology. 
These methods seek to identify areas in feature space and map them to geographic space (pixels) on raster surfaces where the predictive ability of models are likely to deteriorate relative to the globally acquired performance metrics (e.g. RMSE, MAE, AUC-ROC), and under which the model should be used, at best, extra cautiously for decision making. 
These approaches are now considered best practice for ENM modelling and the many alternatives should be investigated for incorporation to seed zone development modelling. 

## Metrics for targeting native plant materials development 

Under our proposed approach numerous metrics could be used by native seed development personnel to prioritize projects. 
For example, the total area covered by a seed zone, statistical metrics of dispersion for resilience of seed zones (e.g. mean or median resilience values of each seed zone), the difference in size between current and forecast seed zones (e.g. zones may expand or contract under scenarios). 
Within zones, areas can be targeted for native seed collection and development which minimize the geographic distance between current and predict seed zones, or environmental similarity between areas currently within a seed zone and projected to be within a seed zone.   